# dry-typescript

A Ruby gem that converts [Dry::Struct](https://dry-rb.org/gems/dry-struct/) definitions to TypeScript types.

## Installation

Add to your Gemfile:

```ruby
gem 'dry-typescript'
```

## Usage

### Basic Usage

```ruby
require 'dry-typescript'

class User < Dry::Struct
  extend Dry::TypeScript::StructMethods

  attribute :name, Types::String
  attribute :age, Types::Integer
  attribute :email, Types::String.optional
end

User.to_typescript
# => { typescript: "type User = {\n  name: string;\n  age: number;\n  email: string | null;\n}", dependencies: [] }
```

### Configuration

```ruby
Dry::TypeScript.configure do |config|
  config.output_dir = "app/javascript/types"
  config.export_keyword = true
  config.null_strategy = :optional  # :nullable, :optional, or :nullable_and_optional
  config.type_name_transformer = ->(name) { "#{name}DTO" }
  config.property_name_transformer = ->(name) { name.to_s.camelize(:lower) }
end
```

### Per-Struct Configuration

```ruby
class User < Dry::Struct
  extend Dry::TypeScript::StructMethods
  extend Dry::TypeScript::PerStructConfig

  typescript_config do |config|
    config.type_name = "UserResponse"
    config.export = true
  end

  attribute :name, Types::String
end
```

### File Generation

#### Using the Writer directly

```ruby
writer = Dry::TypeScript::Writer.new(output_dir: "app/javascript/types")
writer.write_all([User, Address, Order])
writer.cleanup(current_structs: [User, Address, Order])
```

#### Using the Generator

```ruby
generator = Dry::TypeScript::Generator.new(structs: [User, Address, Order])
sorted = generator.sorted_structs  # Topologically sorted by dependencies

writer = Dry::TypeScript::Writer.new
writer.write_all(sorted)
```

#### Rake Tasks

Add to your Rakefile:

```ruby
require 'dry/typescript/rake_task'

Dry::TypeScript::RakeTask.new(:typescript) do |t|
  t.output_dir = "app/javascript/types"
  t.structs = [User, Address, Order]
end
```

This provides:
- `rake typescript:generate` - Generate TypeScript files
- `rake typescript:clean` - Remove generated files

### Rails Integration with File Watching

In Rails applications, dry-typescript can automatically regenerate TypeScript files when your struct files change.

#### Setup

1. Add the `listen` gem to your Gemfile:

```ruby
gem 'listen', group: :development
```

2. Configure in an initializer (`config/initializers/dry_typescript.rb`):

```ruby
Dry::TypeScript.configure do |config|
  config.output_dir = Rails.root.join("app/javascript/types")
  config.dirs = [
    Rails.root.join("app/resources"),
    Rails.root.join("app/structs")
  ]
end
```

The watcher automatically starts in development and regenerates TypeScript files when Ruby files in the configured directories change.

#### Configuration Options

```ruby
# Force enable/disable listening (defaults to auto-detect)
Dry::TypeScript.listen = true   # Force enable
Dry::TypeScript.listen = false  # Force disable
Dry::TypeScript.listen = nil    # Auto-detect (default)

# Disable via environment variable
ENV["DISABLE_DRY_TYPESCRIPT"] = "true"
```

#### Rake Tasks (Rails)

When using Rails, these rake tasks are automatically available:

- `rails dry_typescript:generate` - Generate TypeScript files from all Dry::Struct classes
- `rails dry_typescript:refresh` - Clean and regenerate
- `rails dry_typescript:clean` - Remove generated files
- `rails dry_typescript:check` - Check if types are up to date (for CI)

#### Debugging

Enable debug output to see file watching activity:

```bash
DRY_TYPESCRIPT_DEBUG=1 rails server
```

### Features

- **Fingerprint-based change detection**: Only rewrites files when content changes
- **Import generation**: Automatically generates imports for struct dependencies
- **Barrel exports**: Creates index.ts with all type exports
- **Safe cleanup**: Only removes files generated by dry-typescript
- **Collision detection**: Raises error if multiple structs resolve to same filename
- **Atomic writes**: Uses temp files to prevent partial writes
- **Deterministic output**: Imports and exports are sorted alphabetically

## License

MIT
